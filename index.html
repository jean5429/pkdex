<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PKDex - Pokémons e TM/HM</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at top, #dbeafe 0%, #eff6ff 35%, #f8fafc 100%);
    }

    .glass {
      background: rgba(255, 255, 255, 0.82);
      backdrop-filter: blur(9px);
      border: 1px solid rgba(255, 255, 255, 0.65);
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
    }

    .spinner {
      border: 4px solid rgba(2, 6, 23, 0.12);
      border-top-color: #2563eb;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 0.9s linear infinite;
    }

    .card-hover {
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .card-hover:hover {
      transform: translateY(-3px);
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.12);
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8 text-slate-800">
  <main class="max-w-7xl mx-auto">
    <section class="glass rounded-3xl p-5 md:p-8">
      <header class="space-y-5 border-b border-slate-200 pb-6">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <p class="text-sm uppercase tracking-[0.2em] text-blue-600 font-bold">PKDex</p>
            <h1 class="text-2xl md:text-4xl font-black text-slate-900">Pokédex completa + Guia TM/HM</h1>
            <p class="text-slate-600 mt-2 text-sm md:text-base">Interface renovada com duas abas e dados dinâmicos por versão de jogo.</p>
          </div>
          <div class="w-full md:w-80">
            <label for="game-version-select" class="block text-sm font-semibold text-slate-600 mb-2">Versão do jogo</label>
            <select id="game-version-select" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="red-blue">Red/Blue</option>
              <option value="yellow">Yellow</option>
              <option value="gold-silver">Gold/Silver</option>
              <option value="crystal">Crystal</option>
              <option value="ruby-sapphire">Ruby/Sapphire</option>
              <option value="emerald">Emerald</option>
              <option value="firered-leafgreen">FireRed/LeafGreen</option>
              <option value="diamond-pearl">Diamond/Pearl</option>
              <option value="platinum">Platinum</option>
              <option value="heartgold-soulsilver">HeartGold/SoulSilver</option>
              <option value="black-white">Black/White</option>
              <option value="black-2-white-2">Black 2/White 2</option>
              <option value="x-y">X/Y</option>
              <option value="omega-ruby-alpha-sapphire">Omega Ruby/Alpha Sapphire</option>
              <option value="sun-moon">Sun/Moon</option>
              <option value="ultra-sun-ultra-moon">Ultra Sun/Ultra Moon</option>
              <option value="lets-go-pikachu-lets-go-eevee">Let's Go Pikachu/Eevee</option>
              <option value="sword-shield">Sword/Shield</option>
              <option value="brilliant-diamond-shining-pearl">Brilliant Diamond/Shining Pearl</option>
              <option value="legends-arceus">Legends: Arceus</option>
              <option value="scarlet-violet">Scarlet/Violet</option>
            </select>
          </div>
        </div>

        <nav class="flex flex-wrap gap-2" aria-label="Abas principais">
          <button type="button" data-tab="pokemon" class="tab-btn rounded-full px-5 py-2.5 text-sm font-semibold bg-blue-600 text-white shadow">Pokémons</button>
          <button type="button" data-tab="tmhm" class="tab-btn rounded-full px-5 py-2.5 text-sm font-semibold bg-slate-100 text-slate-700">TM/HM</button>
        </nav>
      </header>

      <section id="pokemon-tab" class="tab-panel pt-6 space-y-5">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <form id="pokemon-search-form" class="w-full md:max-w-lg">
            <label for="pokemon-search" class="block text-sm font-semibold text-slate-600 mb-2">Buscar por nome ou número</label>
            <input id="pokemon-search" type="search" placeholder="Ex.: pikachu, 25, mr mime" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </form>
          <p id="pokemon-count" class="text-sm font-semibold text-slate-600">Carregando Pokémons...</p>
        </div>

        <div id="gen-menu" class="flex flex-wrap gap-2"></div>

        <div id="pokemon-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 md:gap-4">
          <div class="col-span-full py-12 flex justify-center"><div class="spinner"></div></div>
        </div>
      </section>

      <section id="tmhm-tab" class="tab-panel pt-6 space-y-5 hidden">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <form id="tmhm-search-form" class="w-full md:max-w-lg">
            <label for="tmhm-search" class="block text-sm font-semibold text-slate-600 mb-2">Buscar TM/HM ou movimento</label>
            <input id="tmhm-search" type="search" placeholder="Ex.: tm10, surf, thunderbolt" class="w-full rounded-xl border border-slate-300 bg-white px-4 py-3 text-sm shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
          </form>
          <p id="tmhm-count" class="text-sm font-semibold text-slate-600">Escolha uma versão para listar TM/HM.</p>
        </div>

        <div id="tmhm-list" class="grid gap-3 md:gap-4">
          <div class="rounded-2xl border border-dashed border-slate-300 bg-white/70 p-6 text-sm text-slate-600">Carregando dados de TM/HM...</div>
        </div>
      </section>
    </section>
  </main>

  <script>
    const state = {
      selectedGameVersion: 'red-blue',
      pokemon: [],
      pokemonFiltered: [],
      selectedGeneration: null,
      tmhm: [],
      tmhmFiltered: [],
      activeTab: 'pokemon',
      cache: {
        tmhmItems: null,
        machineByUrl: new Map(),
      },
    };

    const generationRanges = [
      { label: '1ª Gen', min: 1, max: 151 },
      { label: '2ª Gen', min: 152, max: 251 },
      { label: '3ª Gen', min: 252, max: 386 },
      { label: '4ª Gen', min: 387, max: 493 },
      { label: '5ª Gen', min: 494, max: 649 },
      { label: '6ª Gen', min: 650, max: 721 },
      { label: '7ª Gen', min: 722, max: 809 },
      { label: '8ª Gen', min: 810, max: 905 },
      { label: '9ª Gen', min: 906, max: 1025 },
      { label: 'Todas', min: 1, max: 1025 },
    ];

    const refs = {
      gameVersionSelect: document.getElementById('game-version-select'),
      pokemonGrid: document.getElementById('pokemon-grid'),
      pokemonCount: document.getElementById('pokemon-count'),
      pokemonSearch: document.getElementById('pokemon-search'),
      genMenu: document.getElementById('gen-menu'),
      tmhmList: document.getElementById('tmhm-list'),
      tmhmCount: document.getElementById('tmhm-count'),
      tmhmSearch: document.getElementById('tmhm-search'),
      pokemonTab: document.getElementById('pokemon-tab'),
      tmhmTab: document.getElementById('tmhm-tab'),
      tabButtons: document.querySelectorAll('.tab-btn'),
    };

    function formatLabel(value) {
      return value
        .replace(/-/g, ' ')
        .split(' ')
        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function setActiveTab(tabName) {
      state.activeTab = tabName;
      refs.tabButtons.forEach((btn) => {
        const isActive = btn.dataset.tab === tabName;
        btn.className = `tab-btn rounded-full px-5 py-2.5 text-sm font-semibold ${isActive ? 'bg-blue-600 text-white shadow' : 'bg-slate-100 text-slate-700'}`;
      });

      refs.pokemonTab.classList.toggle('hidden', tabName !== 'pokemon');
      refs.tmhmTab.classList.toggle('hidden', tabName !== 'tmhm');
    }

    function navigateToDetails(pokemonId) {
      window.location.href = `./details.html?id=${pokemonId}&version=${state.selectedGameVersion}`;
    }

    function renderGenerationFilters() {
      refs.genMenu.innerHTML = generationRanges
        .map((range) => {
          const isActive = state.selectedGeneration && state.selectedGeneration.min === range.min && state.selectedGeneration.max === range.max;
          return `<button type="button" data-min="${range.min}" data-max="${range.max}" class="gen-btn rounded-full px-3 py-2 text-xs font-bold ${isActive ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700'}">${range.label}</button>`;
        })
        .join('');

      document.querySelectorAll('.gen-btn').forEach((button) => {
        button.addEventListener('click', () => {
          const min = Number(button.dataset.min);
          const max = Number(button.dataset.max);

          if (state.selectedGeneration && state.selectedGeneration.min === min && state.selectedGeneration.max === max) {
            state.selectedGeneration = null;
          } else {
            state.selectedGeneration = { min, max };
          }

          applyPokemonFilters();
          renderGenerationFilters();
        });
      });
    }

    function applyPokemonFilters() {
      const term = refs.pokemonSearch.value.trim().toLowerCase();

      state.pokemonFiltered = state.pokemon.filter((pokemon) => {
        const byGeneration = !state.selectedGeneration || (pokemon.id >= state.selectedGeneration.min && pokemon.id <= state.selectedGeneration.max);
        const normalizedName = pokemon.name.replace(/-/g, ' ');
        const byTerm = !term || String(pokemon.id).includes(term) || pokemon.name.includes(term) || normalizedName.includes(term);
        return byGeneration && byTerm;
      });

      renderPokemonGrid();
    }

    function renderPokemonGrid() {
      if (!state.pokemonFiltered.length) {
        refs.pokemonGrid.innerHTML = '<p class="col-span-full rounded-2xl border border-dashed border-slate-300 bg-white p-10 text-center text-sm text-slate-600">Nenhum Pokémon encontrado com os filtros atuais.</p>';
        refs.pokemonCount.textContent = '0 resultados';
        return;
      }

      refs.pokemonGrid.innerHTML = state.pokemonFiltered
        .map((pokemon) => `
          <article class="card-hover rounded-2xl border border-slate-200 bg-white p-3 text-center shadow-sm cursor-pointer" onclick="navigateToDetails(${pokemon.id})">
            <p class="text-xs font-black text-slate-500">#${pokemon.id}</p>
            <img loading="lazy" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemon.id}.png" alt="${formatLabel(pokemon.name)}" class="mx-auto h-20 w-20 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/96x96/e2e8f0/64748b?text=?';" />
            <h3 class="text-sm font-bold text-slate-700 break-words">${formatLabel(pokemon.name)}</h3>
          </article>`)
        .join('');

      refs.pokemonCount.textContent = `${state.pokemonFiltered.length} Pokémon(s)`;
    }

    async function fetchPokemonData() {
      refs.pokemonGrid.innerHTML = '<div class="col-span-full py-12 flex justify-center"><div class="spinner"></div></div>';
      try {
        const response = await fetch('https://pokeapi.co/api/v2/pokemon?limit=1025');
        if (!response.ok) throw new Error(`Erro HTTP ${response.status}`);
        const data = await response.json();
        state.pokemon = data.results.map((entry, index) => ({ id: index + 1, name: entry.name }));
        applyPokemonFilters();
      } catch (error) {
        console.error('Erro ao carregar Pokémons:', error);
        refs.pokemonGrid.innerHTML = '<p class="col-span-full rounded-2xl border border-red-200 bg-red-50 p-8 text-center text-sm text-red-700">Falha ao carregar lista de Pokémons. Tente novamente mais tarde.</p>';
        refs.pokemonCount.textContent = 'Erro ao carregar';
      }
    }

    async function fetchMachineDetail(machineUrl) {
      if (state.cache.machineByUrl.has(machineUrl)) {
        return state.cache.machineByUrl.get(machineUrl);
      }

      const response = await fetch(machineUrl);
      if (!response.ok) throw new Error(`Erro ao buscar machine: ${response.status}`);
      const machineData = await response.json();
      state.cache.machineByUrl.set(machineUrl, machineData);
      return machineData;
    }

    async function fetchTmHmItems() {
      if (state.cache.tmhmItems) {
        return state.cache.tmhmItems;
      }

      const response = await fetch('https://pokeapi.co/api/v2/item-category/tmhs');
      if (!response.ok) throw new Error(`Erro ao carregar categoria TM/HM: ${response.status}`);
      const category = await response.json();

      const itemDetails = await Promise.all(
        category.items.map(async (item) => {
          const itemResponse = await fetch(item.url);
          if (!itemResponse.ok) throw new Error(`Erro ao carregar item ${item.name}: ${itemResponse.status}`);
          return itemResponse.json();
        })
      );

      state.cache.tmhmItems = itemDetails;
      return itemDetails;
    }

    async function fetchTmHmByVersion(versionGroup) {
      refs.tmhmCount.textContent = 'Carregando TM/HM...';
      refs.tmhmList.innerHTML = '<div class="rounded-2xl border border-slate-200 bg-white p-6"><div class="spinner mx-auto"></div></div>';

      try {
        const items = await fetchTmHmItems();
        const tmhmEntries = [];

        for (const item of items) {
          const matchingMachines = (item.machines || []).filter((machineRef) => machineRef.version_group.name === versionGroup);

          for (const machineRef of matchingMachines) {
            let moveName = 'Movimento desconhecido';
            try {
              const machineData = await fetchMachineDetail(machineRef.machine.url);
              moveName = machineData.move?.name || moveName;
            } catch (error) {
              console.warn('Falha ao buscar detalhe de machine:', error);
            }

            const isHm = item.name.startsWith('hm');
            tmhmEntries.push({
              itemName: item.name,
              moveName,
              type: isHm ? 'HM' : 'TM',
              location: 'Localização específica não está disponível na PokeAPI para TM/HM nesta versão.',
            });
          }
        }

        tmhmEntries.sort((a, b) => a.itemName.localeCompare(b.itemName, undefined, { numeric: true }));
        state.tmhm = tmhmEntries;
        applyTmHmFilters();
      } catch (error) {
        console.error('Erro ao carregar TM/HM:', error);
        refs.tmhmCount.textContent = 'Erro ao carregar TM/HM';
        refs.tmhmList.innerHTML = '<div class="rounded-2xl border border-red-200 bg-red-50 p-6 text-sm text-red-700">Não foi possível carregar TM/HM da versão selecionada no momento.</div>';
      }
    }

    function applyTmHmFilters() {
      const term = refs.tmhmSearch.value.trim().toLowerCase();

      state.tmhmFiltered = state.tmhm.filter((entry) => {
        const normalizedItem = entry.itemName.replace(/-/g, ' ');
        const normalizedMove = entry.moveName.replace(/-/g, ' ');
        return !term || entry.itemName.includes(term) || normalizedItem.includes(term) || entry.moveName.includes(term) || normalizedMove.includes(term);
      });

      renderTmHmList();
    }

    function renderTmHmList() {
      if (!state.tmhmFiltered.length) {
        refs.tmhmList.innerHTML = '<div class="rounded-2xl border border-dashed border-slate-300 bg-white p-6 text-sm text-slate-600">Nenhuma TM/HM encontrada para essa versão com o filtro aplicado.</div>';
        refs.tmhmCount.textContent = '0 resultados';
        return;
      }

      refs.tmhmList.innerHTML = state.tmhmFiltered
        .map((entry) => `
          <article class="card-hover rounded-2xl border border-slate-200 bg-white p-4 md:p-5 shadow-sm">
            <div class="flex flex-wrap items-center gap-2 mb-2">
              <span class="inline-flex items-center rounded-full ${entry.type === 'HM' ? 'bg-amber-100 text-amber-800' : 'bg-blue-100 text-blue-700'} px-2.5 py-1 text-xs font-black">${entry.type}</span>
              <h3 class="text-base md:text-lg font-bold text-slate-800">${formatLabel(entry.itemName)}</h3>
            </div>
            <p class="text-sm text-slate-700"><span class="font-semibold">Movimento:</span> ${formatLabel(entry.moveName)}</p>
            <p class="text-sm text-slate-600 mt-1"><span class="font-semibold">Localização:</span> ${entry.location}</p>
          </article>`)
        .join('');

      refs.tmhmCount.textContent = `${state.tmhmFiltered.length} TM/HM encontradas em ${formatLabel(state.selectedGameVersion)}`;
    }

    function setupEvents() {
      refs.tabButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          setActiveTab(btn.dataset.tab);
        });
      });

      refs.pokemonSearch.addEventListener('input', applyPokemonFilters);
      refs.tmhmSearch.addEventListener('input', applyTmHmFilters);

      refs.gameVersionSelect.addEventListener('change', async (event) => {
        state.selectedGameVersion = event.target.value;
        localStorage.setItem('selectedPokemonGameVersion', state.selectedGameVersion);
        await fetchTmHmByVersion(state.selectedGameVersion);
      });
    }

    async function init() {
      const storedVersion = localStorage.getItem('selectedPokemonGameVersion');
      if (storedVersion) {
        state.selectedGameVersion = storedVersion;
        refs.gameVersionSelect.value = storedVersion;
      }

      renderGenerationFilters();
      setupEvents();
      await Promise.all([fetchPokemonData(), fetchTmHmByVersion(state.selectedGameVersion)]);
    }

    document.addEventListener('DOMContentLoaded', init);
    window.navigateToDetails = navigateToDetails;
  </script>
</body>
</html>
